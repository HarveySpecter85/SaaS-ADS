---
phase: 06-external-data
plan: 02
type: execute
depends_on: ["06-01"]
files_modified: [src/lib/weather.ts, src/app/api/data-sources/[id]/sync/route.ts, src/app/(dashboard)/data-sources/new/page.tsx, src/app/(dashboard)/data-sources/[id]/page.tsx]
---

<objective>
Implement weather data integration with OpenWeatherMap API.

Purpose: Enable weather-based contextual triggers by connecting to a weather API and caching current conditions.
Output: Weather API integration, sync endpoint, and data source creation/detail UI.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-external-data/06-CONTEXT.md
@.planning/phases/06-external-data/06-01-SUMMARY.md

**From CONTEXT.md - Vision:**
- Weather-based triggers (temperature, conditions, forecasts)
- Easy data connection: non-technical setup
- Flexibility for different clients/locations

**From 06-01 (data source foundation available):**
- DataSource table with type='weather' and config JSONB
- DataSourceValue table for cached values
- CRUD API endpoints for data sources
- WeatherConfig type: { api_key?, location, units }

**Weather integration approach:**
- Use OpenWeatherMap free tier API
- Cache weather data with 30-minute expiry
- Store: temperature, conditions, humidity, wind
- Support location search by city name
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create weather API integration library</name>
  <files>src/lib/weather.ts</files>
  <action>
Create src/lib/weather.ts:

```typescript
// OpenWeatherMap API integration

interface WeatherData {
  temperature: number;
  feels_like: number;
  humidity: number;
  conditions: string;
  description: string;
  icon: string;
  wind_speed: number;
  location: string;
  fetched_at: string;
}

// Fetch current weather from OpenWeatherMap
export async function fetchWeather(
  location: string,
  units: 'metric' | 'imperial' = 'metric',
  apiKey?: string
): Promise<WeatherData>

// Parse OpenWeatherMap response to our format
function parseWeatherResponse(data: any, location: string): WeatherData

// Get weather icon URL
export function getWeatherIconUrl(icon: string): string
```

Implementation notes:
- Use OpenWeatherMap Current Weather API: `api.openweathermap.org/data/2.5/weather`
- API key from config or env var `OPENWEATHER_API_KEY`
- Parse response to extract: temp, feels_like, humidity, weather[0].main, weather[0].description, weather[0].icon, wind.speed
- Return structured WeatherData object
- Handle API errors gracefully (invalid location, rate limit, etc.)
- Include fetched_at timestamp for cache validation

Do NOT store API keys in code. Read from config or environment.
  </action>
  <verify>npm run build succeeds, weather.ts compiles without errors</verify>
  <done>Weather API client can fetch current conditions for any location</done>
</task>

<task type="auto">
  <name>Task 2: Create sync endpoint for data sources</name>
  <files>src/app/api/data-sources/[id]/sync/route.ts</files>
  <action>
Create src/app/api/data-sources/[id]/sync/route.ts:

```typescript
// POST: Sync data source (fetch fresh data from external API)
```

POST implementation:
1. Fetch data source by ID
2. Based on type, call appropriate sync function:
   - 'weather': Call fetchWeather with config.location, config.units, config.api_key
   - 'calendar': Just return existing events (no external fetch needed)
   - 'custom': Just return existing data (no external fetch needed)
3. For weather: Store values in data_source_values:
   - key: 'current' → value: full WeatherData object
   - key: 'temperature' → value: { value: number, unit: 'C' | 'F' }
   - key: 'conditions' → value: { main: string, description: string }
4. Set expires_at to 30 minutes from now
5. Update data_source.last_sync_at
6. Return synced values

Error handling:
- 404 if data source not found
- 400 if weather API fails (with error message)
- 500 for database errors
  </action>
  <verify>npm run build succeeds, no TypeScript errors</verify>
  <done>POST /api/data-sources/[id]/sync fetches and caches external data</done>
</task>

<task type="auto">
  <name>Task 3: Create data source creation and detail pages</name>
  <files>src/app/(dashboard)/data-sources/new/page.tsx, src/app/(dashboard)/data-sources/[id]/page.tsx, src/app/(dashboard)/data-sources/[id]/client.tsx</files>
  <action>
1. Create src/app/(dashboard)/data-sources/new/page.tsx:

**Wizard-style creation flow:**

Step 1: Select type
- Three large cards: Weather, Calendar, Custom
- Each with icon and description
- Click to select and proceed

Step 2: Configure (based on type)

**For Weather:**
- Location input (city name, e.g., "London, UK")
- Units toggle: Celsius / Fahrenheit
- Optional: API key input (use default if not provided)
- "Test Connection" button to verify location works

**For Calendar:**
- Name input
- "Add Event" button
- Event form: name, date picker, type (Holiday/Event/Sale)
- List of added events

**For Custom:**
- Name input
- JSON editor or key-value pairs
- "Add Field" button for key-value

Step 3: Review & Create
- Show summary of configuration
- Create button

After creation, redirect to /data-sources/[id]

2. Create src/app/(dashboard)/data-sources/[id]/page.tsx (Server Component):
- Fetch data source with values
- Render DataSourceDetailClient

3. Create src/app/(dashboard)/data-sources/[id]/client.tsx (Client Component):

**Header:**
- Data source name (editable)
- Type badge
- Status toggle (Active/Inactive)
- Delete button

**For Weather type:**
- Current conditions display:
  - Large temperature number
  - Weather icon
  - Conditions text
  - Humidity, wind, feels-like
- Location display
- Last synced timestamp
- "Sync Now" button

**For Calendar type:**
- List of events
- Add/edit/delete events
- Upcoming events highlighted

**For Custom type:**
- Key-value display
- Edit JSON/fields

**Common:**
- Edit configuration section
- Danger zone: Delete data source

Style: Match campaign detail page patterns. Visual, clean, informative.
  </action>
  <verify>npm run build succeeds, pages render at /data-sources/new and /data-sources/[id]</verify>
  <done>Users can create weather/calendar/custom data sources and view current values</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] Weather API integration works (with test location)
- [ ] Sync endpoint updates cached values
- [ ] Create page wizard works for all types
- [ ] Detail page displays current values
- [ ] No TypeScript or ESLint errors
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Weather data can be fetched and cached
- Data source creation wizard works
- Detail page shows synced values
- Ready for Trigger Rules Engine (Plan 03)
</success_criteria>

<output>
After completion, create `.planning/phases/06-external-data/06-02-SUMMARY.md`

Commit guidance:
- Task 1: `feat(06-02): create weather API integration library`
- Task 2: `feat(06-02): create data source sync endpoint`
- Task 3: `feat(06-02): create data source creation and detail pages`
- Metadata: `docs(06-02): complete weather integration plan`
</output>
