---
phase: 06-external-data
plan: 01
type: execute
depends_on: []
files_modified: [supabase/migrations/005_data_sources.sql, src/lib/supabase/database.types.ts, src/app/api/data-sources/route.ts, src/app/api/data-sources/[id]/route.ts]
---

<objective>
Create database schema and API endpoints for external data sources.

Purpose: Establish the foundation for connecting external data sources (weather, inventory, calendar) that will power contextual triggers.
Output: Supabase tables for data sources, CRUD API endpoints, and TypeScript types.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-external-data/06-CONTEXT.md

**From CONTEXT.md - Vision:**
- Contextual triggers: weather, inventory, time-based events
- Easy data connection: non-technical setup
- Out of scope: automated bidding (just connect data)

**Tech stack available:**
- Supabase (database, storage, RLS)
- Established API route patterns from campaigns/assets
- TypeScript types in database.types.ts

**Established patterns:**
- Supabase API route pattern with createClient from server.ts
- UUID validation helper
- Cascade delete for related data
- TypeScript interfaces for all database entities

**Data source types to support:**
- Weather (OpenWeatherMap API)
- Calendar/Events (holidays, special dates)
- Custom (user-defined key-value data)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database schema for data sources</name>
  <files>supabase/migrations/005_data_sources.sql, src/lib/supabase/database.types.ts</files>
  <action>
1. Create supabase/migrations/005_data_sources.sql:

```sql
-- External data sources for contextual triggers
create table data_sources (
  id uuid primary key default gen_random_uuid(),
  name text not null,
  type text not null check (type in ('weather', 'calendar', 'custom')),
  config jsonb not null default '{}',
  -- Weather: { api_key, location, units }
  -- Calendar: { events: [...] }
  -- Custom: { data: {...} }
  is_active boolean not null default true,
  last_sync_at timestamptz,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

-- Cached data from external sources
create table data_source_values (
  id uuid primary key default gen_random_uuid(),
  data_source_id uuid references data_sources(id) on delete cascade,
  key text not null,
  value jsonb not null,
  expires_at timestamptz,
  created_at timestamptz default now()
);

-- Enable RLS
alter table data_sources enable row level security;
alter table data_source_values enable row level security;

-- Policies for authenticated users
create policy "Authenticated users can CRUD data_sources" on data_sources
  for all using (auth.role() = 'authenticated');

create policy "Authenticated users can CRUD data_source_values" on data_source_values
  for all using (auth.role() = 'authenticated');

-- Indexes
create index idx_data_sources_type on data_sources(type);
create index idx_data_source_values_source_id on data_source_values(data_source_id);
create index idx_data_source_values_key on data_source_values(key);
create unique index idx_data_source_values_unique on data_source_values(data_source_id, key);
```

2. Update src/lib/supabase/database.types.ts - ADD to existing types:

```typescript
// Data source types
export type DataSourceType = 'weather' | 'calendar' | 'custom';

export interface WeatherConfig {
  api_key?: string;
  location: string;
  units: 'metric' | 'imperial';
}

export interface CalendarConfig {
  events: Array<{
    name: string;
    date: string;
    type: 'holiday' | 'event' | 'sale';
  }>;
}

export interface CustomConfig {
  data: Record<string, unknown>;
}

export type DataSourceConfig = WeatherConfig | CalendarConfig | CustomConfig;

export interface DataSource {
  id: string;
  name: string;
  type: DataSourceType;
  config: DataSourceConfig;
  is_active: boolean;
  last_sync_at: string | null;
  created_at: string;
  updated_at: string;
}

export interface DataSourceValue {
  id: string;
  data_source_id: string;
  key: string;
  value: unknown;
  expires_at: string | null;
  created_at: string;
}

export interface DataSourceWithValues extends DataSource {
  values: DataSourceValue[];
}
```
  </action>
  <verify>npm run build succeeds, types file compiles without errors</verify>
  <done>Migration SQL documented, TypeScript types defined for DataSource and DataSourceValue</done>
</task>

<task type="auto">
  <name>Task 2: Create data source CRUD API endpoints</name>
  <files>src/app/api/data-sources/route.ts, src/app/api/data-sources/[id]/route.ts</files>
  <action>
1. Create src/app/api/data-sources/route.ts:

```typescript
// GET: List all data sources (filter by type query param)
// POST: Create new data source
```

- GET returns data sources with optional `?type=weather` filter
- Order by created_at descending
- POST accepts: { name, type, config, is_active }
- Validate type is one of: weather, calendar, custom
- Use createClient from '@/lib/supabase/server'
- Return proper HTTP status codes (200, 201, 400, 500)

2. Create src/app/api/data-sources/[id]/route.ts:

```typescript
// GET: Get single data source with cached values
// PATCH: Update data source config
// DELETE: Delete data source (cascades to values)
```

- GET returns data source with related values
- PATCH allows updating: name, config, is_active
- DELETE removes data source and all cached values
- Validate UUID format for id parameter
- Return 404 for non-existent data sources

Follow the pattern from /api/campaigns/[id]/route.ts.
  </action>
  <verify>npm run build succeeds, no TypeScript errors in API routes</verify>
  <done>Data source API endpoints created: GET/POST /api/data-sources, GET/PATCH/DELETE /api/data-sources/[id]</done>
</task>

<task type="auto">
  <name>Task 3: Create data sources UI page</name>
  <files>src/app/(dashboard)/data-sources/page.tsx, src/app/(dashboard)/data-sources/client.tsx, src/components/data-source-card.tsx</files>
  <action>
1. Create src/components/data-source-card.tsx:

Card component showing:
- Data source name
- Type badge (Weather/Calendar/Custom with color coding)
- Status indicator (Active/Inactive with green/gray dot)
- Last synced timestamp (or "Never")
- Config summary (e.g., "New York, USA" for weather)
- Click to navigate to detail/edit page

Style: Match existing card patterns (BrandCard, ProductCard). White background, subtle shadow, hover state.

2. Create src/app/(dashboard)/data-sources/page.tsx (Server Component):

```typescript
// Fetch all data sources
// Render DataSourcesClient
```

3. Create src/app/(dashboard)/data-sources/client.tsx (Client Component):

**Header:**
- "Data Sources" title
- "Add Data Source" button

**Filter tabs:**
- All / Weather / Calendar / Custom

**Grid of DataSourceCard components**

**Empty state:**
- "No data sources yet"
- "Connect external data to power contextual ad triggers"
- "Add Data Source" button

Style: Match gallery page layout. Clean, visual-first.
  </action>
  <verify>npm run build succeeds, page renders at /data-sources</verify>
  <done>Data sources list page displays connected sources with type filtering</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] TypeScript types compile without errors
- [ ] API route files have correct exports (GET, POST, PATCH, DELETE)
- [ ] /data-sources page renders
- [ ] No ESLint errors
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Database types defined and importable
- Data source CRUD API endpoints exist
- Data sources list page works
- Ready for Weather Integration (Plan 02)
</success_criteria>

<output>
After completion, create `.planning/phases/06-external-data/06-01-SUMMARY.md`

Commit guidance:
- Task 1: `feat(06-01): add data source database types and migration`
- Task 2: `feat(06-01): create data source CRUD API endpoints`
- Task 3: `feat(06-01): create data sources list page`
- Metadata: `docs(06-01): complete data source foundation plan`
</output>
