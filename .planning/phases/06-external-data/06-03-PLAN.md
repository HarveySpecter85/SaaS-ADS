---
phase: 06-external-data
plan: 03
type: execute
depends_on: ["06-02"]
files_modified: [supabase/migrations/006_trigger_rules.sql, src/lib/supabase/database.types.ts, src/app/api/trigger-rules/route.ts, src/app/api/trigger-rules/[id]/route.ts, src/app/(dashboard)/data-sources/[id]/client.tsx, src/lib/trigger-engine.ts]
---

<objective>
Create the trigger rules engine that links data source signals to campaigns.

Purpose: Enable users to define rules like "When temperature > 25°C, suggest cold drink ads" that connect external data to creative recommendations.
Output: Trigger rules database, API, UI for rule creation, and evaluation engine.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-external-data/06-CONTEXT.md
@.planning/phases/06-external-data/06-02-SUMMARY.md

**From CONTEXT.md - Vision:**
- Contextual triggers that surface relevant creative variations
- "When X happens, use Y creative" logic
- Out of scope: automated bidding (just recommendations)

**From 06-02 (weather integration available):**
- DataSource with cached values
- Sync endpoint refreshes data
- Weather data includes: temperature, conditions, humidity, wind

**Trigger rule concept:**
- A rule links a data source condition to campaign recommendations
- Condition: data_source.key operator value (e.g., temperature > 25)
- Action: Recommend campaigns with matching goal/tags
- Rules evaluate against current data source values
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create trigger rules database schema</name>
  <files>supabase/migrations/006_trigger_rules.sql, src/lib/supabase/database.types.ts</files>
  <action>
1. Create supabase/migrations/006_trigger_rules.sql:

```sql
-- Trigger rules linking data sources to campaigns
create table trigger_rules (
  id uuid primary key default gen_random_uuid(),
  name text not null,
  data_source_id uuid references data_sources(id) on delete cascade,

  -- Condition: what to check
  condition_key text not null,  -- e.g., 'temperature', 'conditions'
  condition_operator text not null check (condition_operator in (
    'eq', 'neq', 'gt', 'gte', 'lt', 'lte', 'contains', 'not_contains'
  )),
  condition_value text not null,  -- e.g., '25', 'Rain'

  -- Action: what to recommend
  action_type text not null default 'recommend_goal' check (action_type in (
    'recommend_goal',   -- Recommend campaigns with matching goal
    'recommend_tag',    -- Recommend campaigns with tag (future)
    'show_message'      -- Display a message (future)
  )),
  action_value text not null,  -- e.g., 'conversion', 'summer-sale'

  -- Metadata
  is_active boolean not null default true,
  priority integer not null default 0,  -- Higher = evaluated first
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

-- Enable RLS
alter table trigger_rules enable row level security;

-- Policies for authenticated users
create policy "Authenticated users can CRUD trigger_rules" on trigger_rules
  for all using (auth.role() = 'authenticated');

-- Indexes
create index idx_trigger_rules_data_source on trigger_rules(data_source_id);
create index idx_trigger_rules_active on trigger_rules(is_active) where is_active = true;
```

2. Update src/lib/supabase/database.types.ts - ADD:

```typescript
// Trigger rule types
export type ConditionOperator = 'eq' | 'neq' | 'gt' | 'gte' | 'lt' | 'lte' | 'contains' | 'not_contains';
export type TriggerActionType = 'recommend_goal' | 'recommend_tag' | 'show_message';

export interface TriggerRule {
  id: string;
  name: string;
  data_source_id: string;
  condition_key: string;
  condition_operator: ConditionOperator;
  condition_value: string;
  action_type: TriggerActionType;
  action_value: string;
  is_active: boolean;
  priority: number;
  created_at: string;
  updated_at: string;
}

export interface TriggerRuleWithSource extends TriggerRule {
  data_source: DataSource;
}

export interface TriggerEvaluation {
  rule: TriggerRule;
  triggered: boolean;
  current_value: unknown;
  recommended_campaigns?: Campaign[];
}
```
  </action>
  <verify>npm run build succeeds, types compile</verify>
  <done>Trigger rules table and types defined</done>
</task>

<task type="auto">
  <name>Task 2: Create trigger rules API and evaluation engine</name>
  <files>src/app/api/trigger-rules/route.ts, src/app/api/trigger-rules/[id]/route.ts, src/lib/trigger-engine.ts</files>
  <action>
1. Create src/lib/trigger-engine.ts:

```typescript
// Trigger evaluation engine

export function evaluateCondition(
  operator: ConditionOperator,
  currentValue: unknown,
  targetValue: string
): boolean

// Evaluate: is this rule triggered by current data source values?
export function evaluateRule(
  rule: TriggerRule,
  values: DataSourceValue[]
): { triggered: boolean; currentValue: unknown }

// Evaluate all active rules and return triggered ones
export async function evaluateAllRules(
  supabase: SupabaseClient
): Promise<TriggerEvaluation[]>

// Get recommended campaigns based on triggered rules
export async function getRecommendedCampaigns(
  supabase: SupabaseClient,
  triggeredRules: TriggerRule[]
): Promise<Campaign[]>
```

Implementation notes:
- evaluateCondition handles type coercion (number comparisons for gt/lt/etc)
- For 'contains'/'not_contains', check if value includes substring
- evaluateAllRules joins rules with data_source_values to get current data
- getRecommendedCampaigns filters campaigns by goal matching action_value

2. Create src/app/api/trigger-rules/route.ts:

```typescript
// GET: List all trigger rules (filter by data_source_id, is_active)
// POST: Create new trigger rule
```

- GET supports ?data_source_id=uuid and ?active=true filters
- Include data_source relation in response
- POST validates condition_operator and action_type

3. Create src/app/api/trigger-rules/[id]/route.ts:

```typescript
// GET: Get single rule with evaluation status
// PATCH: Update rule
// DELETE: Delete rule
```

- GET includes current evaluation: is this rule triggered right now?
- PATCH allows updating: name, condition_*, action_*, is_active, priority
- Follow established CRUD patterns
  </action>
  <verify>npm run build succeeds, evaluation engine compiles</verify>
  <done>Trigger rules API and evaluation engine working</done>
</task>

<task type="auto">
  <name>Task 3: Add trigger rules UI to data source detail</name>
  <files>src/app/(dashboard)/data-sources/[id]/client.tsx</files>
  <action>
Update src/app/(dashboard)/data-sources/[id]/client.tsx to add trigger rules section:

**New section: "Trigger Rules"**

**Rule list:**
- Card for each rule showing:
  - Rule name
  - Condition: "When [key] [operator] [value]"
  - Action: "Recommend [goal] campaigns"
  - Status badge: Triggered (green) / Not triggered (gray)
  - Toggle: Active/Inactive
  - Edit/Delete buttons

**Add Rule form (inline or modal):**
- Name input
- Condition builder:
  - Key dropdown (populated from data source value keys: temperature, conditions, etc.)
  - Operator dropdown (equals, greater than, less than, contains, etc.)
  - Value input
- Action builder:
  - Action type dropdown (Recommend by goal)
  - Goal dropdown (Awareness/Lead Gen/Conversion)
- Save button

**Example rules for weather:**
- "Hot Weather" → When temperature > 25 → Recommend conversion campaigns
- "Rainy Day" → When conditions contains "Rain" → Recommend awareness campaigns

**Visual feedback:**
- When a rule is triggered, show which campaigns would be recommended
- Preview panel: "Currently recommending: [N] campaigns"

Style: Clean form layout. Visual rule cards. Real-time evaluation feedback.
  </action>
  <verify>npm run build succeeds, trigger rules UI renders on data source detail page</verify>
  <done>Users can create trigger rules and see real-time evaluation</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] Trigger rules can be created via API
- [ ] Evaluation engine correctly evaluates conditions
- [ ] Rules UI shows on data source detail page
- [ ] Triggered rules display recommended campaigns
- [ ] No TypeScript or ESLint errors
- [ ] Phase 6 complete
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Trigger rules table and types defined
- Evaluation engine works correctly
- Rules UI integrates with data source detail
- Users can define contextual triggers
- Phase 6 complete
</success_criteria>

<output>
After completion, create `.planning/phases/06-external-data/06-03-SUMMARY.md`

Commit guidance:
- Task 1: `feat(06-03): create trigger rules database schema`
- Task 2: `feat(06-03): create trigger rules API and evaluation engine`
- Task 3: `feat(06-03): add trigger rules UI to data source detail`
- Metadata: `docs(06-03): complete trigger rules engine plan`

Note: This is the final plan for Phase 6. After SUMMARY.md, update ROADMAP.md and STATE.md to mark Phase 6 complete.
</output>
