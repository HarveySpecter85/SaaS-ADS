---
phase: 01-foundation
plan: 02
type: execute
depends_on: ["01-01"]
files_modified: [src/app/login/page.tsx, src/app/auth/callback/route.ts, src/middleware.ts, src/lib/supabase/middleware.ts]
---

<objective>
Set up Supabase Auth with email/password login for team members.

Purpose: Enable team members to authenticate and access the application.
Output: Working login flow with protected routes, unauthenticated users redirected to login.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-01-SUMMARY.md

**From PROJECT.md:**
- Internal tool for agency (no public signup, just team members)
- Simple auth - no complex permissions needed

**From CONTEXT.md:**
- Auth that works - simple email/password login
- Team members stay logged in (no friction)
- No complex permissions (everyone has same access)

**Tech available (from 01-01):**
- @supabase/supabase-js and @supabase/ssr installed
- Supabase client utilities in src/lib/supabase/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Supabase Auth middleware and callback handler</name>
  <files>src/middleware.ts, src/lib/supabase/middleware.ts, src/app/auth/callback/route.ts</files>
  <action>
Set up auth infrastructure for Next.js App Router:

1. Create src/lib/supabase/middleware.ts:
   - Export updateSession function that refreshes auth session
   - Use createServerClient from @supabase/ssr with cookie handling
   - This keeps the session fresh on each request

2. Create src/middleware.ts:
   - Import and call updateSession from lib/supabase/middleware
   - Configure matcher to run on all routes except static files and api routes that don't need auth
   - Redirect unauthenticated users to /login for protected routes
   - Protected routes: everything except /login and /auth/*

3. Create src/app/auth/callback/route.ts:
   - Handle OAuth/magic link callbacks (even though we use email/password, this is standard pattern)
   - Exchange code for session using Supabase client
   - Redirect to / on success

Follow official Supabase Next.js App Router middleware patterns.
Use @supabase/ssr (not deprecated auth-helpers).
  </action>
  <verify>npm run build passes, middleware.ts has no TypeScript errors</verify>
  <done>Middleware runs on requests, unauthenticated users redirected to /login, callback route exists</done>
</task>

<task type="auto">
  <name>Task 2: Create login page with email/password form</name>
  <files>src/app/login/page.tsx, src/app/login/actions.ts</files>
  <action>
Create simple, clean login page:

1. Create src/app/login/page.tsx:
   - Server Component that renders login form
   - Clean, centered card design using Tailwind
   - Linear-style aesthetic: minimal, professional
   - Email and password inputs with proper labels
   - Submit button that calls server action
   - Error message display area
   - No signup link (internal tool - users created in Supabase dashboard)

2. Create src/app/login/actions.ts:
   - "use server" directive
   - login(formData) action using Supabase signInWithPassword
   - Handle errors gracefully (return error message, don't throw)
   - On success: redirect to /
   - Use revalidatePath and redirect from next/navigation

Style requirements:
- White/light background, dark text
- Subtle shadow on card
- Clean input styling (border, focus ring)
- Button with hover state
- Should feel professional, not like a prototype

Do NOT add signup functionality - team members are created in Supabase dashboard.
Do NOT add "forgot password" yet - keep it minimal.
  </action>
  <verify>npm run dev shows login page at /login, form submits without JS errors, invalid credentials show error message</verify>
  <done>Login page renders at /login, form works with Supabase Auth, errors display cleanly, successful login redirects to /</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] Visiting / while logged out redirects to /login
- [ ] Login page renders with clean design
- [ ] Invalid credentials show error message (not crash)
- [ ] Note: Can't test successful login without Supabase credentials - that's expected
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Auth flow works end-to-end (with valid Supabase credentials)
- Unauthenticated users cannot access protected routes
- Login page has professional appearance
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`

Commit guidance:
- Task 1: `feat(01-02): add Supabase auth middleware and callback`
- Task 2: `feat(01-02): create login page with email/password`
- Metadata: `docs(01-02): complete team auth plan`
</output>
