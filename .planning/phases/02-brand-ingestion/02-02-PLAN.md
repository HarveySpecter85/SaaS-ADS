---
phase: 02-brand-ingestion
plan: 02
type: execute
depends_on: ["02-01"]
files_modified: [src/app/api/brands/upload/route.ts, src/lib/pdf-extraction.ts, src/lib/gemini.ts]
---

<objective>
Implement PDF upload and automatic brand data extraction using Gemini.

Purpose: Enable "drop a PDF, auto-extract colors/fonts/tone" workflow.
Output: Upload endpoint that parses PDF and creates brand with extracted data.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-brand-ingestion/02-CONTEXT.md
@.planning/phases/02-brand-ingestion/02-01-SUMMARY.md

**From CONTEXT.md - Vision:**
- Drop a PDF, system auto-extracts
- Minimal manual input required
- Easy editing is more important than extraction accuracy

**Tech stack:**
- Google AI Studio APIs (Gemini) - from PROJECT.md constraints
- Supabase Storage for PDF files
- Next.js API routes

**Approach:**
1. Upload PDF to Supabase Storage
2. Extract text from PDF using pdf-parse
3. Send text to Gemini for structured extraction
4. Create brand with extracted data
5. Return brand for immediate viewing/editing
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create Gemini client</name>
  <files>package.json, src/lib/gemini.ts, .env.local.example</files>
  <action>
1. Install required packages:
```bash
npm install pdf-parse @google/generative-ai
npm install -D @types/pdf-parse
```

2. Create src/lib/gemini.ts:

```typescript
import { GoogleGenerativeAI } from '@google/generative-ai';

const genAI = new GoogleGenerativeAI(process.env.GOOGLE_AI_API_KEY!);

export const gemini = genAI.getGenerativeModel({ model: 'gemini-1.5-flash' });

export interface ExtractedBrandData {
  name: string;
  description: string;
  colors: Array<{
    hex_code: string;
    name: string | null;
    usage: string | null;
    is_primary: boolean;
  }>;
  fonts: Array<{
    font_family: string;
    font_weight: string | null;
    usage: string | null;
    is_primary: boolean;
  }>;
  tone: Array<{
    descriptor: string;
    example: string | null;
  }>;
}

export async function extractBrandFromText(pdfText: string): Promise<ExtractedBrandData> {
  const prompt = `Extract brand guidelines from this PDF text. Return ONLY valid JSON matching this structure:

{
  "name": "Brand name",
  "description": "Brief brand description",
  "colors": [
    {"hex_code": "#FFFFFF", "name": "Primary White", "usage": "Backgrounds", "is_primary": true}
  ],
  "fonts": [
    {"font_family": "Helvetica", "font_weight": "Bold", "usage": "Headlines", "is_primary": true}
  ],
  "tone": [
    {"descriptor": "Professional", "example": "We speak with authority..."}
  ]
}

Rules:
- Extract ALL colors mentioned (hex codes). If no hex provided, skip that color.
- Extract ALL fonts mentioned.
- Extract tone of voice descriptors and examples.
- is_primary should be true for the main/primary variant.
- Return empty arrays if category not found.
- Return ONLY the JSON, no markdown or explanation.

PDF Text:
${pdfText.slice(0, 15000)}`;

  const result = await gemini.generateContent(prompt);
  const text = result.response.text();

  // Parse JSON from response (handle potential markdown wrapping)
  const jsonMatch = text.match(/\{[\s\S]*\}/);
  if (!jsonMatch) {
    throw new Error('Failed to extract JSON from Gemini response');
  }

  return JSON.parse(jsonMatch[0]) as ExtractedBrandData;
}
```

3. Update .env.local.example to include:
```
GOOGLE_AI_API_KEY=your_google_ai_api_key_here
```

Use gemini-1.5-flash for speed and cost efficiency. The prompt is designed to handle messy PDF text and return structured data.
  </action>
  <verify>npm run build succeeds, gemini.ts compiles</verify>
  <done>Gemini client configured, extractBrandFromText function ready</done>
</task>

<task type="auto">
  <name>Task 2: Create PDF upload and extraction endpoint</name>
  <files>src/app/api/brands/upload/route.ts, src/lib/pdf-extraction.ts</files>
  <action>
1. Create src/lib/pdf-extraction.ts:

```typescript
import pdf from 'pdf-parse';

export async function extractTextFromPdf(buffer: Buffer): Promise<string> {
  const data = await pdf(buffer);
  return data.text;
}
```

2. Create src/app/api/brands/upload/route.ts:

```typescript
// POST: Upload PDF, extract brand data, create brand record
```

Implementation:
- Accept multipart/form-data with PDF file
- Extract text from PDF using pdf-parse
- Send text to Gemini for structured extraction
- Upload PDF to Supabase Storage (brands bucket)
- Create brand record with extracted colors, fonts, tone
- Return complete brand with relations

Steps:
1. Parse form data, get file
2. Validate file is PDF (check content-type or extension)
3. Convert to Buffer, extract text with pdf-parse
4. Call extractBrandFromText(text)
5. Upload original PDF to Supabase Storage
6. Insert brand record with source_pdf_url
7. Insert colors, fonts, tone records
8. Return full brand with all relations

Error handling:
- 400 if no file uploaded
- 400 if not a PDF
- 500 if extraction fails (with error message)
- 500 if database insert fails

Keep extraction best-effort. If Gemini returns partial data, that's fine - user can edit.
  </action>
  <verify>npm run build succeeds, no TypeScript errors</verify>
  <done>POST /api/brands/upload endpoint accepts PDF, extracts data, creates brand</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] pdf-parse and @google/generative-ai installed
- [ ] Gemini client exports extractBrandFromText function
- [ ] Upload endpoint handles PDF → text → Gemini → database flow
- [ ] Error cases return appropriate status codes
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- PDF upload extracts brand data automatically
- Extracted data stored in database
- Ready for brand profile UI (Plan 03)
</success_criteria>

<output>
After completion, create `.planning/phases/02-brand-ingestion/02-02-SUMMARY.md`

Commit guidance:
- Task 1: `feat(02-02): add Gemini client and brand extraction`
- Task 2: `feat(02-02): create PDF upload endpoint`
- Metadata: `docs(02-02): complete PDF extraction plan`
</output>
