---
phase: 09-campaign-dashboard
plan: 02
type: execute
depends_on: ["09-01"]
files_modified: [src/app/api/dashboard/route.ts, src/app/(dashboard)/page.tsx]
---

<objective>
Create the main dashboard with real-time metrics and activity overview.

Purpose: Replace placeholder dashboard with actionable metrics showing brands, campaigns, assets, and API usage.
Output: Dashboard API endpoint and updated home page with live data.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**From ROADMAP.md - Phase 9 Goal:**
- Dashboard showing campaigns per client, creative history, API usage metrics
- Multi-client management for agency use

**From 09-01:** API usage tracking ready

**Existing patterns:**
- Dashboard page at src/app/(dashboard)/page.tsx
- Server components for data fetching
- Existing API patterns

**Key files:**
@src/app/(dashboard)/page.tsx
@src/lib/supabase/database.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dashboard metrics API</name>
  <files>src/app/api/dashboard/route.ts</files>
  <action>
Create src/app/api/dashboard/route.ts:

```typescript
import { NextResponse } from 'next/server';
import { createClient } from '@/lib/supabase/server';
import { getUsageStats } from '@/lib/api-usage';

export interface DashboardMetrics {
  brands: {
    total: number;
    recent: { id: string; name: string; created_at: string }[];
  };
  campaigns: {
    total: number;
    by_status: { status: string; count: number }[];
    recent: { id: string; name: string; status: string; created_at: string }[];
  };
  assets: {
    total: number;
    by_status: { status: string; count: number }[];
  };
  prompts: {
    total: number;
  };
  conversions: {
    total: number;
    pending: number;
    sent: number;
    failed: number;
  };
  api_usage: {
    total_requests: number;
    total_tokens: number;
    total_cost_usd: number;
  };
}

export async function GET() {
  const supabase = await createClient();

  // Fetch all metrics in parallel
  const [
    brandsResult,
    campaignsResult,
    assetsResult,
    promptsResult,
    conversionsResult,
    usageStats,
  ] = await Promise.all([
    // Brands
    supabase
      .from('brands')
      .select('id, name, created_at')
      .order('created_at', { ascending: false })
      .limit(5),

    // Campaigns
    supabase
      .from('campaigns')
      .select('id, name, status, created_at')
      .order('created_at', { ascending: false })
      .limit(5),

    // Assets
    supabase.from('assets').select('id, status'),

    // Prompts
    supabase.from('prompts').select('id', { count: 'exact', head: true }),

    // Conversions
    supabase.from('conversion_events').select('id, sync_status'),

    // API Usage
    getUsageStats(30),
  ]);

  // Process brands
  const brands = {
    total: brandsResult.data?.length || 0,
    recent: (brandsResult.data || []).slice(0, 5),
  };

  // Count total brands
  const { count: totalBrands } = await supabase
    .from('brands')
    .select('*', { count: 'exact', head: true });
  brands.total = totalBrands || 0;

  // Process campaigns
  const campaignData = campaignsResult.data || [];
  const statusCounts = campaignData.reduce((acc, c) => {
    acc[c.status] = (acc[c.status] || 0) + 1;
    return acc;
  }, {} as Record<string, number>);

  const { count: totalCampaigns } = await supabase
    .from('campaigns')
    .select('*', { count: 'exact', head: true });

  const campaigns = {
    total: totalCampaigns || 0,
    by_status: Object.entries(statusCounts).map(([status, count]) => ({ status, count })),
    recent: campaignData.slice(0, 5),
  };

  // Process assets
  const assetData = assetsResult.data || [];
  const assetStatusCounts = assetData.reduce((acc, a) => {
    acc[a.status] = (acc[a.status] || 0) + 1;
    return acc;
  }, {} as Record<string, number>);

  const assets = {
    total: assetData.length,
    by_status: Object.entries(assetStatusCounts).map(([status, count]) => ({ status, count })),
  };

  // Process prompts
  const prompts = {
    total: promptsResult.count || 0,
  };

  // Process conversions
  const conversionData = conversionsResult.data || [];
  const conversions = {
    total: conversionData.length,
    pending: conversionData.filter(c => c.sync_status === 'pending').length,
    sent: conversionData.filter(c => c.sync_status === 'sent').length,
    failed: conversionData.filter(c => c.sync_status === 'failed').length,
  };

  const metrics: DashboardMetrics = {
    brands,
    campaigns,
    assets,
    prompts,
    conversions,
    api_usage: {
      total_requests: usageStats.total_requests,
      total_tokens: usageStats.total_tokens,
      total_cost_usd: usageStats.total_cost_usd,
    },
  };

  return NextResponse.json(metrics);
}
```
  </action>
  <verify>npm run build succeeds, GET /api/dashboard returns metrics</verify>
  <done>Dashboard metrics API ready</done>
</task>

<task type="auto">
  <name>Task 2: Update dashboard home page with live metrics</name>
  <files>src/app/(dashboard)/page.tsx</files>
  <action>
Replace src/app/(dashboard)/page.tsx with a server component that fetches and displays real metrics:

```typescript
import { createClient } from '@/lib/supabase/server';
import Link from 'next/link';
import { getUsageStats } from '@/lib/api-usage';

async function getMetrics() {
  const supabase = await createClient();

  const [
    { count: brandCount },
    { count: campaignCount },
    { count: assetCount },
    { count: promptCount },
    { data: recentBrands },
    { data: recentCampaigns },
    { data: conversions },
    usageStats,
  ] = await Promise.all([
    supabase.from('brands').select('*', { count: 'exact', head: true }),
    supabase.from('campaigns').select('*', { count: 'exact', head: true }),
    supabase.from('assets').select('*', { count: 'exact', head: true }),
    supabase.from('prompts').select('*', { count: 'exact', head: true }),
    supabase.from('brands').select('id, name, created_at').order('created_at', { ascending: false }).limit(5),
    supabase.from('campaigns').select('id, name, status, created_at').order('created_at', { ascending: false }).limit(5),
    supabase.from('conversion_events').select('sync_status'),
    getUsageStats(30),
  ]);

  const pendingConversions = conversions?.filter(c => c.sync_status === 'pending').length || 0;
  const sentConversions = conversions?.filter(c => c.sync_status === 'sent').length || 0;

  return {
    brandCount: brandCount || 0,
    campaignCount: campaignCount || 0,
    assetCount: assetCount || 0,
    promptCount: promptCount || 0,
    recentBrands: recentBrands || [],
    recentCampaigns: recentCampaigns || [],
    pendingConversions,
    sentConversions,
    totalConversions: conversions?.length || 0,
    usageStats,
  };
}

export default async function DashboardHome() {
  const metrics = await getMetrics();

  return (
    <div className="space-y-8">
      {/* Header */}
      <div>
        <h1 className="text-2xl font-semibold text-slate-900">Dashboard</h1>
        <p className="mt-1 text-slate-600">Overview of your ad orchestration platform.</p>
      </div>

      {/* Key Metrics */}
      <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
        <MetricCard
          title="Brands"
          value={metrics.brandCount}
          href="/brands"
          icon={
            <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M2.25 21h19.5m-18-18v18m10.5-18v18m6-13.5V21M6.75 6.75h.75m-.75 3h.75m-.75 3h.75m3-6h.75m-.75 3h.75m-.75 3h.75M6.75 21v-3.375c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21M3 3h12m-.75 4.5H21m-3.75 3H21m-3.75 3H21" />
            </svg>
          }
          color="blue"
        />
        <MetricCard
          title="Campaigns"
          value={metrics.campaignCount}
          href="/campaigns"
          icon={
            <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6z" />
            </svg>
          }
          color="purple"
        />
        <MetricCard
          title="Assets"
          value={metrics.assetCount}
          href="/gallery"
          icon={
            <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
            </svg>
          }
          color="amber"
        />
        <MetricCard
          title="Prompts"
          value={metrics.promptCount}
          href="/campaigns"
          icon={
            <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 01.865-.501 48.172 48.172 0 003.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" />
            </svg>
          }
          color="green"
        />
      </div>

      {/* Secondary Metrics */}
      <div className="grid gap-4 sm:grid-cols-3">
        <div className="rounded-lg border border-slate-200 bg-white p-5">
          <div className="flex items-center justify-between">
            <h3 className="text-sm font-medium text-slate-600">Conversions</h3>
            <Link href="/conversions" className="text-xs text-blue-600 hover:underline">View all</Link>
          </div>
          <p className="mt-2 text-2xl font-semibold text-slate-900">{metrics.totalConversions}</p>
          <div className="mt-2 flex gap-4 text-xs">
            <span className="text-amber-600">{metrics.pendingConversions} pending</span>
            <span className="text-green-600">{metrics.sentConversions} sent</span>
          </div>
        </div>

        <div className="rounded-lg border border-slate-200 bg-white p-5">
          <div className="flex items-center justify-between">
            <h3 className="text-sm font-medium text-slate-600">API Usage (30d)</h3>
          </div>
          <p className="mt-2 text-2xl font-semibold text-slate-900">{metrics.usageStats.total_requests.toLocaleString()}</p>
          <div className="mt-2 flex gap-4 text-xs">
            <span className="text-slate-500">{(metrics.usageStats.total_tokens / 1000).toFixed(1)}K tokens</span>
            <span className="text-slate-500">${metrics.usageStats.total_cost_usd.toFixed(2)} est.</span>
          </div>
        </div>

        <div className="rounded-lg border border-slate-200 bg-white p-5">
          <div className="flex items-center justify-between">
            <h3 className="text-sm font-medium text-slate-600">Quick Actions</h3>
          </div>
          <div className="mt-3 flex flex-col gap-2">
            <Link href="/brands/new" className="text-sm text-blue-600 hover:underline">+ New Brand</Link>
            <Link href="/campaigns/new" className="text-sm text-blue-600 hover:underline">+ New Campaign</Link>
          </div>
        </div>
      </div>

      {/* Recent Activity */}
      <div className="grid gap-6 lg:grid-cols-2">
        {/* Recent Brands */}
        <div className="rounded-lg border border-slate-200 bg-white">
          <div className="border-b border-slate-200 px-5 py-4 flex items-center justify-between">
            <h3 className="font-medium text-slate-900">Recent Brands</h3>
            <Link href="/brands" className="text-sm text-blue-600 hover:underline">View all</Link>
          </div>
          <div className="divide-y divide-slate-100">
            {metrics.recentBrands.length === 0 ? (
              <p className="px-5 py-4 text-sm text-slate-500">No brands yet. <Link href="/brands/new" className="text-blue-600 hover:underline">Create one</Link></p>
            ) : (
              metrics.recentBrands.map((brand) => (
                <Link key={brand.id} href={`/brands/${brand.id}`} className="block px-5 py-3 hover:bg-slate-50">
                  <p className="text-sm font-medium text-slate-900">{brand.name}</p>
                  <p className="text-xs text-slate-500">{new Date(brand.created_at).toLocaleDateString()}</p>
                </Link>
              ))
            )}
          </div>
        </div>

        {/* Recent Campaigns */}
        <div className="rounded-lg border border-slate-200 bg-white">
          <div className="border-b border-slate-200 px-5 py-4 flex items-center justify-between">
            <h3 className="font-medium text-slate-900">Recent Campaigns</h3>
            <Link href="/campaigns" className="text-sm text-blue-600 hover:underline">View all</Link>
          </div>
          <div className="divide-y divide-slate-100">
            {metrics.recentCampaigns.length === 0 ? (
              <p className="px-5 py-4 text-sm text-slate-500">No campaigns yet. <Link href="/campaigns/new" className="text-blue-600 hover:underline">Create one</Link></p>
            ) : (
              metrics.recentCampaigns.map((campaign) => (
                <Link key={campaign.id} href={`/campaigns/${campaign.id}`} className="block px-5 py-3 hover:bg-slate-50">
                  <div className="flex items-center justify-between">
                    <p className="text-sm font-medium text-slate-900">{campaign.name}</p>
                    <StatusBadge status={campaign.status} />
                  </div>
                  <p className="text-xs text-slate-500">{new Date(campaign.created_at).toLocaleDateString()}</p>
                </Link>
              ))
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

function MetricCard({
  title,
  value,
  href,
  icon,
  color,
}: {
  title: string;
  value: number;
  href: string;
  icon: React.ReactNode;
  color: 'blue' | 'purple' | 'amber' | 'green';
}) {
  const colorClasses = {
    blue: 'bg-blue-100 text-blue-600',
    purple: 'bg-purple-100 text-purple-600',
    amber: 'bg-amber-100 text-amber-600',
    green: 'bg-green-100 text-green-600',
  };

  return (
    <Link href={href} className="rounded-lg border border-slate-200 bg-white p-5 hover:border-slate-300 transition-colors">
      <div className="flex items-center gap-3">
        <div className={`flex h-10 w-10 items-center justify-center rounded-lg ${colorClasses[color]}`}>
          {icon}
        </div>
        <div>
          <p className="text-sm text-slate-600">{title}</p>
          <p className="text-2xl font-semibold text-slate-900">{value}</p>
        </div>
      </div>
    </Link>
  );
}

function StatusBadge({ status }: { status: string }) {
  const classes = {
    draft: 'bg-slate-100 text-slate-600',
    generating: 'bg-amber-100 text-amber-700',
    complete: 'bg-green-100 text-green-700',
  }[status] || 'bg-slate-100 text-slate-600';

  return (
    <span className={`inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium ${classes}`}>
      {status}
    </span>
  );
}
```

**Key features:**
- Real-time metrics fetched server-side
- Key metric cards linking to detail pages
- Recent brands and campaigns lists
- Conversion status summary
- API usage stats (30-day window)
- Quick action links
  </action>
  <verify>npm run build succeeds, dashboard shows live data at localhost:3000</verify>
  <done>Dashboard home page displays real metrics</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] GET /api/dashboard returns aggregated metrics
- [ ] Dashboard home page shows real counts (brands, campaigns, assets, prompts)
- [ ] Recent activity lists show actual data
- [ ] All links work correctly
- [ ] No TypeScript or ESLint errors
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Dashboard shows live metrics
- Recent activity lists functional
- API usage displayed
</success_criteria>

<output>
After completion, create `.planning/phases/09-campaign-dashboard/09-02-SUMMARY.md`

Commit guidance:
- Task 1: `feat(09-02): create dashboard metrics API`
- Task 2: `feat(09-02): update dashboard home page with live metrics`
- Metadata: `docs(09-02): complete dashboard metrics plan`
</output>
