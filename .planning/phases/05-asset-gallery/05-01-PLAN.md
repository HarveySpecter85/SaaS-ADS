---
phase: 05-asset-gallery
plan: 01
type: execute
depends_on: []
files_modified: [supabase/migrations/004_assets.sql, src/lib/supabase/database.types.ts, src/app/api/assets/route.ts, src/app/api/assets/[id]/route.ts, src/app/api/campaigns/[id]/generate-assets/route.ts]
---

<objective>
Create database schema and API endpoints for generated assets (images from prompts).

Purpose: Establish the data foundation for storing generated images and linking them to prompts/campaigns.
Output: Supabase tables for assets, CRUD API endpoints, and asset generation endpoint (stub for now).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-asset-gallery/05-CONTEXT.md
@.planning/phases/04-prompt-generation/04-01-SUMMARY.md

**From CONTEXT.md - Vision:**
- Browse-and-export hub for generated images
- Figma-style organization by campaign/product
- Platform-specific export bundles

**Tech stack available:**
- Supabase (database, storage, RLS)
- Existing patterns from campaigns/prompts tables
- Storage bucket pattern from products (products/{id}/{uuid}.{ext})

**Established patterns:**
- Supabase API route pattern with createClient from server.ts
- TypeScript types in database.types.ts
- UUID validation helper
- Cascade delete for related data

**Constraining decisions:**
- Phase 4 created prompts table with prompt_text (for image generation)
- Assets will link to prompts (one prompt â†’ one or more assets)
- Storage path convention: assets/{campaign_id}/{uuid}.{ext}
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database schema for assets</name>
  <files>supabase/migrations/004_assets.sql, src/lib/supabase/database.types.ts</files>
  <action>
1. Create supabase/migrations/004_assets.sql:

```sql
-- Generated assets (images from prompts)
create table assets (
  id uuid primary key default gen_random_uuid(),
  prompt_id uuid references prompts(id) on delete cascade,
  campaign_id uuid references campaigns(id) on delete cascade,
  image_url text not null,
  width integer not null,
  height integer not null,
  format text not null check (format in ('png', 'jpg', 'webp')),
  platform text, -- 'google_ads', 'meta', 'tiktok', null for original
  status text not null default 'generating' check (status in ('generating', 'complete', 'failed')),
  created_at timestamptz default now()
);

-- Enable RLS
alter table assets enable row level security;

-- Policies for authenticated users
create policy "Authenticated users can CRUD assets" on assets
  for all using (auth.role() = 'authenticated');

-- Indexes
create index idx_assets_prompt_id on assets(prompt_id);
create index idx_assets_campaign_id on assets(campaign_id);
create index idx_assets_platform on assets(platform);
```

2. Update src/lib/supabase/database.types.ts - ADD to existing types:

```typescript
export type AssetFormat = 'png' | 'jpg' | 'webp';
export type AssetStatus = 'generating' | 'complete' | 'failed';
export type AdPlatform = 'google_ads' | 'meta' | 'tiktok';

export interface Asset {
  id: string;
  prompt_id: string;
  campaign_id: string;
  image_url: string;
  width: number;
  height: number;
  format: AssetFormat;
  platform: AdPlatform | null;
  status: AssetStatus;
  created_at: string;
}

export interface AssetWithPrompt extends Asset {
  prompt: Prompt;
}

export interface CampaignWithAssets extends Campaign {
  prompts: Prompt[];
  assets: Asset[];
}
```
  </action>
  <verify>npm run build succeeds, types file compiles without errors</verify>
  <done>Migration SQL documented, TypeScript types defined for Asset</done>
</task>

<task type="auto">
  <name>Task 2: Create asset CRUD API endpoints</name>
  <files>src/app/api/assets/route.ts, src/app/api/assets/[id]/route.ts</files>
  <action>
1. Create src/app/api/assets/route.ts (list assets):

```typescript
// GET: List all assets (filter by campaign_id, prompt_id, platform query params)
```

- GET returns assets with optional filters
- Support `?campaign_id=uuid` to get all assets for a campaign
- Support `?platform=google_ads` to filter by platform
- Order by created_at descending
- Use createClient from '@/lib/supabase/server'
- Return proper HTTP status codes (200, 400, 500)

2. Create src/app/api/assets/[id]/route.ts (get, delete):

```typescript
// GET: Get single asset with prompt info
// DELETE: Delete asset (also removes from storage)
```

- GET returns asset with related prompt data
- DELETE removes asset record and deletes file from Supabase storage
- Validate UUID format for id parameter
- Return 404 for non-existent assets

Follow the pattern from /api/products/[id]/route.ts and /api/campaigns/[id]/route.ts.
  </action>
  <verify>npm run build succeeds, no TypeScript errors in API routes</verify>
  <done>Asset API endpoints created: GET /api/assets, GET/DELETE /api/assets/[id]</done>
</task>

<task type="auto">
  <name>Task 3: Create asset generation endpoint (stub)</name>
  <files>src/app/api/campaigns/[id]/generate-assets/route.ts</files>
  <action>
Create src/app/api/campaigns/[id]/generate-assets/route.ts:

```typescript
// POST: Generate assets for campaign prompts (stub for now)
```

POST implementation (stubbed):
1. Accept JSON body: { prompt_ids?: string[] } (optional - if not provided, generate for all prompts)
2. Fetch campaign with prompts
3. For each selected prompt:
   - Create placeholder asset record with status='generating'
   - TODO: In future, call Imagen 3 API here
   - For now: Create a placeholder image URL (use a gradient or solid color placeholder)
   - Update asset status to 'complete'
4. Return created assets

This is a STUB endpoint. The actual image generation (Imagen 3) will be added later.
For now, store the prompt_text and create placeholder URLs like:
`https://placehold.co/1200x628/333/white?text=Asset+Placeholder`

Use dimensions based on common ad formats:
- Default: 1200x628 (Meta/Google landscape)

Error handling:
- 400 if campaign not found or has no prompts
- 500 if database operation fails
  </action>
  <verify>npm run build succeeds, no TypeScript errors</verify>
  <done>POST /api/campaigns/[id]/generate-assets creates placeholder assets for prompts</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] TypeScript types compile without errors
- [ ] API route files have correct exports (GET, POST, DELETE)
- [ ] No ESLint errors
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Database types defined and importable
- Asset CRUD API endpoints exist
- Stub generation endpoint creates placeholder assets
- Ready for Asset Gallery UI (Plan 02)
</success_criteria>

<output>
After completion, create `.planning/phases/05-asset-gallery/05-01-SUMMARY.md`

Commit guidance:
- Task 1: `feat(05-01): add asset database types and migration`
- Task 2: `feat(05-01): create asset CRUD API endpoints`
- Task 3: `feat(05-01): create stub asset generation endpoint`
- Metadata: `docs(05-01): complete asset data foundation plan`
</output>
